name: SonarCloud Scan

on:
  push:
    branches: [ master ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: Build and analyze
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.sln') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Determine Build Strategy
        id: build-strategy
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          # Get all changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD || git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if any .NET files changed
          DOTNET_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(cs|csproj|sln|razor|cshtml)$' || true)
          
          # Check if any front-end files changed
          FRONTEND_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(js|css|html|ts|scss|svg|png|jpg)$' || true)
          
          if [ -n "$DOTNET_CHANGED" ]; then
            echo "dotnet_changed=true" >> $GITHUB_OUTPUT
            echo ".NET files changed - build required"
            
            # Find specific .csproj files that changed
            CHANGED_PROJECTS=$(echo "$DOTNET_CHANGED" | grep "\.csproj$" || true)
            if [ -z "$CHANGED_PROJECTS" ]; then
              # No .csproj changed, but .cs files did - find which projects they belong to
              CHANGED_CS=$(echo "$DOTNET_CHANGED" | grep "\.cs$" || true)
              if [ -n "$CHANGED_CS" ]; then
                CHANGED_PROJECTS=$(echo "$CHANGED_CS" | xargs -I {} sh -c 'find . -name "*.csproj" -exec grep -l "{}" {} \;' 2>/dev/null | sort -u || true)
              fi
            fi
            
            echo "projects=$(echo "$CHANGED_PROJECTS" | tr '\n' ' ')" >> $GITHUB_OUTPUT
            
          elif [ -n "$FRONTEND_CHANGED" ]; then
            echo "dotnet_changed=false" >> $GITHUB_OUTPUT
            echo "frontend_changed=true" >> $GITHUB_OUTPUT
            echo "Only front-end files changed - skipping .NET build"
          else
            echo "dotnet_changed=false" >> $GITHUB_OUTPUT
            echo "frontend_changed=false" >> $GITHUB_OUTPUT
            echo "No code changes - minimal build"
          fi

      - name: Restore Dependencies
        if: steps.build-strategy.outputs.dotnet_changed == 'true'
        run: dotnet restore

      - name: Build Changed .NET Projects
        if: steps.build-strategy.outputs.dotnet_changed == 'true'
        run: |
          PROJECTS="${{ steps.build-strategy.outputs.projects }}"
          if [ -n "$PROJECTS" ]; then
            echo "Building specific projects: $PROJECTS"
            echo "$PROJECTS" | tr ' ' '\n' | xargs -I {} dotnet build {} --configuration Release --no-restore
          else
            echo "No specific projects detected, building solution"
            dotnet build --configuration Release --no-restore
          fi

      - name: Skip .NET Build (Front-end only)
        if: steps.build-strategy.outputs.dotnet_changed != 'true'
        run: echo "Skipping .NET build - only front-end files changed"

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=mibrahim83_SonarCloud-Test
            -Dsonar.organization=mibrahim83
            -Dsonar.exclusions=**/Migrations/**,**/obj/**,**/bin/**
            -Dsonar.dotnet.excludeTestProjects=true
            -Dsonar.coverage.exclusions=**Tests*/
            -Dsonar.analysisCache.enabled=true