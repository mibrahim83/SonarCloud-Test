name: SonarCloud Fast Scan

on:
  push:
    branches: [ master ]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: Build and analyze
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.sln') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Determine Build Strategy
        id: build-strategy
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD)
          
          # Check for .NET file changes (including .cshtml!)
          DOTNET_CHANGED=$(echo "$CHANGED_FILES" | grep -E '\.(cs|csproj|sln|razor|cshtml)$' || echo "")
          
          if [ -n "$DOTNET_CHANGED" ]; then
            echo "dotnet_changed=true" >> $GITHUB_OUTPUT
            echo ".NET files changed - build required"
            
            # Find specific .csproj files
            CHANGED_PROJECTS=$(echo "$DOTNET_CHANGED" | grep "\.csproj$")
            
            # If no .csproj changed, find projects containing changed .cs/.cshtml files
            if [ -z "$CHANGED_PROJECTS" ]; then
              # For changed .cs/.cshtml files, find their containing .csproj
              # Look for .csproj in parent directories
              for file in $DOTNET_CHANGED; do
                dir=$(dirname "$file")
                while [ "$dir" != "." ]; do
                  if [ -f "$dir"/*.csproj ]; then
                    proj=$(ls "$dir"/*.csproj)
                    CHANGED_PROJECTS="$CHANGED_PROJECTS $proj"
                    break
                  fi
                  dir=$(dirname "$dir")
                done
              done
              CHANGED_PROJECTS=$(echo "$CHANGED_PROJECTS" | tr ' ' '\n' | sort -u)
            fi
            
            echo "projects=$(echo "$CHANGED_PROJECTS" | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Restore Dependencies
        if: steps.build-strategy.outputs.dotnet_changed == 'true'
        run: dotnet restore

      - name: Build
        if: steps.build-strategy.outputs.dotnet_changed == 'true'
        run: |
          PROJECTS="${{ steps.build-strategy.outputs.projects }}"
          if [ -n "$PROJECTS" ]; then
            echo "Building: $PROJECTS"
            echo "$PROJECTS" | tr ' ' '\n' | xargs -I {} dotnet build {} --configuration Release --no-restore
          else
            echo "Building solution"
            dotnet build --configuration Release --no-restore
          fi

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=mibrahim83_SonarCloud-Test
            -Dsonar.organization=mibrahim83
            -Dsonar.exclusions=**/Migrations/**
            -Dsonar.dotnet.excludeTestProjects=true